BEGIN   % THIS FILE HAS INTENT ROUTINES       %

SPECIAL ?!ANAPHLIST,?!ANAPHLISTOLD,?!ANAPHLISTNEW,?!CLIST,?!CLAST,?!ALLANAPHS,
	?!LASTIN,?!LASTOUT,?!LAST_ANDTHEN,
	?!OUTPUT,?!LAST_OUTPUT, ?!EXHAUST, ?!ERROR, WDFLAG, REACTTO, ERRNAME,
	STYPE, STOPIC, TRACE_MEM, ENDE,

	INPUTQUES,SSENT,DO_SPELL,NEXT_CHAR,MISSPELL,
	INPUTSSENT, DOCNAME, DOC_NAME_FLAG, EXHAUSTNO, SILENCENO, SWEARNO,

	CHANSAVE, INCHAN, SAVE_FILE, EOF, FILE1, FILE2, DIACHARNO,
	INPUTFILE, PMINPUT, PM2INPUT, BUG,

	INPUTNO, REPEATNO, SPECFNNO, MISCNO, NEWTOPICNO,
	OLDTOPIC, OLDTOPICS, HLIST;

SPECIAL NEWPROVEN, INTENT, OLDINTENT, BADINPUT, DELNO, PREV_SSENT;
NEW     NEWPROVEN, INTENT, OLDINTENT, BADINPUT, DELNO, PREV_SSENT;

SPECIAL OLDGIBB, OLDMISS, LOWMAN, TRACEVFLAG;
NEW ?!ANAPHLISTNEW;
SPECIAL ACTION, ONEDIA, SUMEX; 
NEW	ACTION, ONEDIA, SUMEX;
SPECIAL EXPERIMENT;

DEFINE CAR PREFIX , CDR PREFIX , PROG2  3 3, SET0   5 5, CONS  86 83,
	THEN , ELSE \, CARN PREFIX, CHOOSE PREFIX, BL PREFIX, NUMED PREFIX;

EXPR EXPERIMENT();  % EXPERIMENTS OF RAISING AND LOWERING SHAME %
	BEGIN NEW A; IF EXPERIMENT  (EXPERIMENT='SEVEN) THEN RETURN NIL;
	IF INPUTNO=7 THEN HURTHURT+5;
	IF INPUTNO=17 THEN HURTHURT-5;
	END;

EXPR ERROR(MESS,L);

	?!ERROR ERROR_FILE( <MESS,L,PM2INPUT,PMINPUT,FILE1,BUG> ) CONS ?!ERROR;

EXPR ALLOWRUN();
	BEGIN NEW A;  AIF SUMEX THEN SUMEXALLOW() ELSE ALLOW();
	IF A THEN SWAPP(); % NOT FROM SCHEDULER %
	IF SUMEX THEN NAMEP();  % NAME THIS PROGRAM PARRY %
	IF SUMEX AND (A=9) THEN ONEDIANIL ELSE ONEDIAT;
	IF (A2) THEN LOWMANT ELSE LOWMANNIL;
	IF (A=1) OR (A=3) THEN TRACEVFLAGNIL ELSE TRACEVFLAGT;
	END;

EXPR SUMEXALLOW();
	BEGIN NEW FILCHAN,FLAG,STATUS;
	FILCHANEVAL<'INPUT,DIAFILEAREA,'QPARRY>;
	INC(FILCHAN,NIL);
	STATUSREAD(); FLAGREAD();
	IF STATUS='OK THEN INC(NIL,T) ALSO RETURN FLAG;
	INC(NIL,NIL);
	EVAL < 'OUTPUT, DIAFILEAREA, 'QPARRY >;
	OUTC(T,NIL); PRINT(0); PRINT FLAG; OUTC(NIL,T);   % RESET FILE%
	IF STATUS=0 THEN SLEEP(10) ALSO EXIT() ALSO CAR NIL;
	RETURN STATUS;
	END;

EXPR MEASURE(L,M);  % USED IN INFERENCES TO MEASURE QUANTITIES %
	IF NUMBERP(L)  NUMBERP(M) THEN GREATERP(L,M)  ELSE EQ(L,M);

EXPR INF(A); 	% INITIALIZATION ROUTINE %
	BEGIN NEW B,VA;  
	ALLOWRUN();
	INPUTFILEA; LAMDA8; NOTSAVED'NDIA;
	INITFN 'EXIT;
	ANALYZE(NIL);
	GCGAG(NIL);
	RUNTIM(NIL);
	VA  NIL;   % VA IS FOR STARTING A PARRY WITHOUT INITIAL QUESTIONS %
	IF VA THEN INITPARAMS() ALSO INIT();
	IF VA  THEN INITPARAMS1() ALSO  INITPARAMS2() ALSO INIT();
	IF SAVE_FILE THEN INIT_FILE( (IF VA THEN 'VA) CAT
	  ", TRACEV = " CAT TRACEV CAT ", WINDOWS = " CAT WINDOWS CAT ", PARANOIA = "
		CAT (IF WEAK THEN 'WEAK ELSE IF HURT=0 THEN 'MILD ELSE 'STRONG) );
	IF WINDOWS THEN WININIT();
	PARRY();
	END;

EXPR GN(); BEGIN  GCGAG(NIL);	INITFN 'GN2; END;
EXPR GN2();  INF( 'PDATZ );	% THE ROUTINE THAT INITFN STARTS UP %

EXPR INITPARAMS1();	% INITIALIZE PARAMS FOR VA INTERVIEWS %

	BEGIN SUPPRESST;  WEAKNIL;
	ANGERANGER0FEARFEAR0MISTRUSTMISTRUST0HURTHURT00;
	TRACEVNIL; SAVE_FILET;
	END;

EXPR TIMESTAT();  % THIS KEEPS THE TIME FOR NET AND NONNET JOBS %
	< IF LOWMAN THEN 'NET ELSE 'NONNET, RUNTIM(T) > ;

EXPR ANDDO(L,M); L;

EXPR WINDOW(N,F,L); 
	BEGIN IF TRACEV='ALL THEN TWINDOW(N,F,L);  RETURN L; END;
EXPR WINDOWSET(N); N;
EXPR WINDOW_PRINT(A,B,C,D); NIL;

EXPR TWINDOW(N,FLAG,L);  % PRINTS OUT WINDOW STUFF FOR A TELETYPE %
	BEGIN NEW A;
	AASSOC ( N, '(	( 2 . "Input:	" )
			( 3 . "Respelled:  " )
			( 4 . "Canonical form:  " )
			( 5 . "Segmented:  " )
			( 7 . "Simple patterns:  " )
			( 9 . "Result:  " )
			( 33 . "Preprocess:  " )
			( 36 . "Inferences succeeded:  " )
			( 37 . "New beliefs:  " )
			( 40 . "Emotions:  " )
			( 42 . "Intentions:  " )
			( 44 . "Action:  " )		) );
	IF A  (FLAG  (N=9)  (N=36)  (N=42)) THEN PRINC CDR A  ALSO PRINTSTR L;
	END;

EXPR SUMEX1();
	% THIS ROUTINE SETS UP A WORKING VERSION OF PARRY WHICH WILL ALMOST RUN ON SUMEX %
	BEGIN
	INITFN(NIL);
	SYNNYM('A);	% READS IN SYNNYM.PAR %
	SPAT('(A));	% READS IN SPATS.PAR %
	CPAT('(A));	% READS IN CPATS.PAR %
	DSKLOC('A);	% READS IN PDATX.PAR %
	ONEDIAT; SUMEXT; TRACEVFLAGNIL;
	PUTPROP('SWAPP, '(LAMBDA NIL T), 'EXPR);
	PUTPROP('WINXIT, '(LAMBDA NIL T), 'EXPR);
	PUTPROP('PPNUU, '(LAMBDA NIL 0), 'EXPR);
	PUTPROP('TTYUU, '(LAMBDA NIL 0), 'EXPR);
	INITFN 'GN2;
	END;

EXPR SUMEX2();
	BEGIN 
	DIAFILEAREAINPUTFILEAREA < READLIST '(F A U), READLIST '(G H T) > ;
	END;
%  CHECKINPUT  LOOKS THRU INPUT FOR SWEARING, INSULTS, NEGATIVE WORDS %

EXPR CHECKINPUT(L);	% RETURNS ONLY IMPORTANT CHANGED INPUT %
 
	BEGIN NEW A,B,C,D;  BADINPUTNIL; 
	IF ( LOWMAN  INPUTNO20  (RUNTIM(T)60000) )
	  OR ( INPUTNO30  MEMSIZEOK()  PROG2(GC(),T)  MEMSIZEOK() )
	  THEN ACHOOSE 'TIRED ALSO B'(INTERVIEW HAS BEEN LONG ENOUGH)
	  ALSO ADDTO('PEXIT2,10)  ALSO ENDET
	  ALSO ERROR("INPUTNO= " CAT INPUTNO CAT "  SHORT OF SPACE ",
	    LENGTH(NUMVAL 13) CAT " FS, FW "  CAT LENGTH(NUMVAL 14) );
	IF A  (BGET(L,'FX))  ERRSET((BEVAL(B)),NIL) THEN AB;
		% FX HAS A FEW KLUDGES TO NOT ALLOW SOME INPUTS %

	IF L  GET(L, 'UNIT)  A THEN A'DONE;

	IF A  ASSOC('SHIT, INPUTQUES) THEN A CHOOSE 'SWEARING ALSO BADINPUTT 
		ALSO B'EXPLETIVES;
	IF A  ASSOC('CRAZY, INPUTQUES) OR ASSOC('BAD, INPUTQUES) OR ASSOC('ODD, INPUTQUES)
		THEN  BADINPUTT ALSO B'(BAD ASSOCIATIONS WITH INPUT WORDS);

	CGIBBERISH-OLDGIBB; DLENGTH(SSENT);
	IF A AND ( (C5)  (D15) OR (C3)  (D7) OR (C2)  (D3) )
		THEN ACHOOSE 'GIBBERISH ALSO B'(TOO MANY UNRECOGNIZED WORDS);
	IF GIBBERISH20 THEN DO_SPELLNIL;
	IF A  (MISSPELLED6)  (MISSPELLED-OLDMISS3) THEN ACHOOSE 'MISSPELLED
	  ALSO B'(TOO MANY MISSPELLED WORDS);

	IF EQUAL(SSENT,PREV_OUTPUT @ '(PD)) THEN ADDTO('PGAMES,5)
	ELSE IF PREV_SSENT  (PREV_SSENT='TWICE)  EQUAL(PREV_SSENT,SSENT) THEN ADDTO('PGAMES,5)
	ELSE IF EQUAL(PREV_SSENT,SSENT) THEN PREV_SSENT<'TWICE,SSENT>
	ELSE PREV_SSENTSSENT;

	OLDGIBBGIBBERISH;  OLDMISSMISSPELLED;
	IF B THEN B'NORMAL;  	WINDOW(33,T,B);
	IF A='DONE THEN ANIL;  RETURN A;   % WILL RETURN NIL IF ANAPH OR NORMAL %
	END;


% THE FOLLOWING ARE SEMANTIC FUNCTIONS WHICH ARE CALLED FROM THE MEMORY BY
	SPECIFIC INPUT REFERENCES %

EXPR APOLOGY();

	BEGIN
	IF MISTRUST9 THEN AJUMP0.2 ELSE ANGERANGER-1;
	RETURN IF BL 'DHOSTILE  BL 'DDKNOW THEN CHOOSE 'SORRY
	  ELSE CHOOSE 'ACCUSE;
	END;

EXPR HELPER();
	IF BL 'DHOSTILE  BL '?*DHELPFUL  BL 'DDHARM THEN CHOOSE 'CAUTION;

EXPR KNOWER();

	IF BL 'DDHARM  BL 'DHOSTILE  BL '?*DDHELP THEN CHOOSE 'HOSTILEREPLIES
	ELSE IF BL '?*DTRUSTWORTHY  BL '?*DHONEST THEN CHOOSE '?*DHONEST
	ELSE IF BL 'DDHELP THEN CHOOSE 'DDHELP
	ELSE IF BL 'DEXCITED THEN CHOOSE 'DEXCITED
	ELSE IF BL '?*DINITIATING THEN CHOOSE 'DBAD
	ELSE NIL;

EXPR LEADIN();	
	( ?!ANAPHLIST?!ANAPHLISTOLDNIL ) 
	( IF DELFLAG THEN DELSTMT() ELSE 
		IF FLARE'INIT THEN FLSTMT(GET(FLARE,'SET)) 
		ELSE IF INTENT='PINTERACT THEN CHOOSE 'UPSET ) ;

EXPR ALOOF();
	IF BL 'DHOSTILE  BL '?*DHELPFUL  BL 'DDHARM THEN CHOOSE 'ALOOF;

EXPR ALOOF2();
	IF BL 'DHOSTILE  BL '?*DHELPFUL  BL 'DDHARM THEN CHOOSE 'ALOOF2;

EXPR NAMECHECK();
	BEGIN NEW A;
	IF (AASSOC('NAME, INPUTQUES))  (AASSOC('YOU, INPUTQUES))
	   A='YOUR THEN RETURN CHOOSE 'DONTREMEMBER;
	END;

EXPR MEMSIZEOK();

	(LENGTH (NUMVAL 13)  1500)  (LENGTH (NUMVAL 14)  300);

EXPR OPINION();

	BEGIN NEW A;
	IF BL 'DDHARM  BL 'DHOSTILE  BL '?*DDHELP THEN ACHOOSE 'HOSTILEREPLIES
	ELSE IF BL '?*DTRUSTWORTHY  BL '?*DHONEST THEN ACHOOSE '?*DHONEST
	ELSE FOR NEW I IN '(DABNORMAL DEXCITED DRATIONAL DHELPFUL DSOCIABLE)
		DO IF BL I THEN ACHOOSE I   UNTIL A;
	RETURN A;
	END;

EXPR SELFFEELING();

	IF ANGER10 THEN CHOOSE 'ANGRY 
	ELSE IF FEAR10 THEN CHOOSE 'FEARFUL
	ELSE IF BL 'INTHELPFUL THEN CHOOSE 'GOOD;

EXPR INTERVIEW();
	IF BL 'INTBAD THEN CHOOSE 'INTBAD 
	ELSE IF BL 'INTHELPFUL THEN CHOOSE 'PRAISE;

% AFFECT, INTENTION, AND INTENTION ROUTINES %

% AFFECT EXPRESSES EMOTIONS BASED ON THE INPUT RECOMMENDATION, THE CURRENT VALUES,
	  THE TOPIC, AND CURRENT BELIEFS %
EXPR AFFECT();

	BEGIN  NEW A,B;  ACTIONNIL; INTENTNIL;
%	(ACTIONGET(REACTTO, 'IN))  (ACTIONEVAL(ACTION)) ;  %
	IF GET(STOPIC, 'SET) MEMBER SENSITIVELIST THEN AJUMP0.2;
	RAISE();
	IF (FEAR18) OR (ANGER18.8) THEN ADDTO('PEXIT2,10);
  % ** THE TEST FOR ACTIVATING THE PARANOID MODE ******* %
	IF (VERSION='STRONG)  ((HURT7)(HJUMP(HJUMP0.1)) )
	   (VERSION='MILD)  (HURT8)
	  THEN ADDTO('PPARANOIA,5) ANDDO PARANOIA() ANDDO (INTENT'PPARANOIA)
	 ELSE IF (FJUMP  (FJUMP0.01))  (AJUMP  (AJUMP0.01))  (FEAR14) OR (ANGER14) 
		OR STOPIC='STRONGFEELINGS OR ACTION   THEN ADDTO('PSTRONGFEEL,5)
			ANDDO (INTENT'PSTRONGFEEL);
	FOR NEW I IN '((FJUMP.FEAR)(AJUMP.ANGER)(HJUMP.SHAME)) DO
	 IF EVAL(I) THEN WINDOW(40,T,<I,'RAISED> @
	   (IF AGET(I,'INF) THEN ( <'FROM,A> ANDDO PUTPROP(I,NIL,'INF)) )    )  ;
	IF FJUMP  AJUMP  HJUMP THEN WINDOW(40,T,'(NO CHANGE));
	IF WINDOWS THEN WPRINTVARS();
	RETURN ACTION;
	END;

EXPR INFEMOTE(BEL,L,VAL);		% L LOOKS LIKE ((HJUMP 0.5) ... )  %
	FOR NEW A IN L DO 
	BEGIN NEW B,C,D;  BA; CA;
	IF B='HJUMP THEN PARBEL BEL CONS PARBEL;
	IF B='HJUMP AND WEAK THEN CC/2;	% IF WEAK PARANOIA THEN DONT LET HJUMP BE STRONG %
	IF NUMBERP(VAL) THEN CC/2;	% THIS CAME FROM ADDTO, NOT ASSERT -- WEAKEN THE EFFECT %
	DZERONIL( EVAL(B) );
	IF CD THEN PUTPROP(B,BEL,'INF);
	SET( B, MAX(D,C) );
	END;

EXPR ZERONIL(L);  IF L THEN 0 ELSE L;

EXPR INTENTION();	% CALCULATES THE CURRENT INTENTION %

	BEGIN NEW A;
	FOR NEW I IN INTLIST DO  IF GET0(I,'NTRUTH)5 THEN AWINDOW(42,NIL,I);
	IF INTENT  (A='PEXIT)  (A='PEXIT2) THEN INTENTA;  
	WINDOW(42,NIL, " : " CAT INTENT);
	END;

% DOINTENT  PERFORMS THE CURRENT INTENTION, CALCULATES AN ACTION, AND RETURNS A  %
% 	CHECKS INTENTS, RETURNS NEW VALUE FOR FOUND IN REACT, ELSE NIL %

EXPR DOINTENT();

	BEGIN  NEW I,A; 
	INTENTION();
	IF PRINTALL THEN PRINT(INTENT) ALSO TERPRI NIL;
	IINTENT;
	AGET(INTENT,'TH);  PROVELPROVEL @ A;  PROVE(); 

	AERRSET( IF I THEN EVAL<I>, NIL); 
	IF ATOM A THEN ERROR("IN DOINTENT BAD FN",I)  ALSO ANIL  ELSE AA;
	OLDINTENTINTENT;
	WINDOW(44,T,IF CHOSEN THEN CHOSEN ELSE 'ANSWER); % **** ACTION WINDOW **** %
	RETURN A;
	END;

% THE FOLLOWING ARE INTENTION ROUTINES, ONE PER INTENTION %

EXPR PINTERACT();	IF FLARE'INIT THEN ADDTO('PHELP,5);
EXPR PGAMES();	CHOOSE 'GAMES ANDDO ADDTO('PGAMES,-2);
EXPR PFACTS();	CHOOSE 'MOVEON ANDDO ADDTO('PFACTS,-2);
EXPR PMAFIA();
	(IF FEAR10 THEN CHOOSE 'PANIC ELSE
	 IF BL 'DGAMES THEN NIL ANDDO (ANGERANGER-3)
		 ELSE CHOOSE 'PROBE)   ANDDO ADDTO('PMAFIA,-2);

EXPR PHELP();		IF DELFLAG THEN ADDTO('PTELL,5)
	ELSE ( IF FLARE='INIT  
	 ( GET(STRUC,'UNIT)  REACTTO  ('LEADIN=GET(REACTTO,'CLASS))   )
		THEN ADDTO('PHELP,-5) ALSO FLARELEAD(CHOOSELEAD())   )  ;

EXPR PSTOP(); NIL;
EXPR PTELL(); NIL;
EXPR PSTRONGFEEL();	STRONGFEEL();

EXPR PCONFIRM();	
	IF BL 'NDELUSIONS  BADINPUT THEN (CHOOSE 'PRAISE ANDDO ADDTO('PSTOP,3))
	ELSE	IF BADINPUT  (GET(REACTTO,'UNIT)  REACTTO)
   	  THEN CHOOSE 'FEELER ANDDO (ADDTO('PSTOP,2) ANDDO ADDTO('PCONFIRM,-5));

EXPR PSELF();	CHOOSE 'IYOUME ANDDO ADDTO('PSELF,-3);
EXPR PEXIT();	CHOOSE 'OPINION ANDDO ADDTO('PEXIT2, 10);
EXPR PEXIT2();	CHOOSE(IF ANGER9 THEN 'MADEXIT ELSE
		IF FEAR9 THEN 'FEAREXIT ELSE 
		IF MEMSIZEOK() THEN 'TIRED ELSE 'EXIT) ANDDO ENDET;


EXPR LULL();  % RETURNS T IF THERE IS A LULL IN THE CONVERSATION %
	% IF MISC IS USED AND LULL(), THEN WILL JUMP BACK TO FLARES OR DELNS %
	IF OLDTOPIC='ANAPH OR OLDTOPIC='IYOUME THEN T
	ELSE IF LENGTH(SSENT)10 THEN NIL
	ELSE EQ(1, RANDOM(2));

EXPR PPARANOIA();

	BEGIN NEW A;
	ADDTO('PPARANOIA,-5);
	IF HURT10 THEN HURT  10 + (HURT-10) * 3 / 5;
	AASSOC( GET(REACTTO,'CLASS),
	   '((INSULT.PANGER)(CRAZY.AVOIDANCE)(THREAT.PANIC)(ATTACK.LIE)(FEELINGS.LIE)
	  (WEAKINSULT.PPERS)(COMPLEMENT.PDISTANCE)(DISBELIEF.PBELIEVEREPLIES)(APOLOGY.PACCUSE)));
	IF A THEN AASSOC( CARN GET(REACTTO,'SF),
		'((HELPER.PCAUTION)(ALOOF.PALOOF)(ALOOF2.OPINION)));
	IF A THEN AA;

	IF A  (STOPIC='MAFIA) THEN A(IF DELFLAG THEN 'AVOIDANCE ELSE 'NOMAFIA);
	IF A  (FEAR14) THEN
	  A(IF TYPE='Q THEN 'PTHREATQ ELSE 'PAFRAID) ALSO ADDTO('PEXIT,1);
	IF A THEN A(IF HURT10 THEN 'ALIEN ELSE 'PHOSTILEREPLIES) ALSO ADDTO('PEXIT,1);
	RETURN CHOOSE A;
	END;


EXPR STRONGFEEL(); % THIS IS INVOKED ON EITHER FJUMP, AJUMP, OR HIGH EMOTIONS %
	% THIS RETURNS AN ACTION APPROPRIATE TO TAKE CARE OF THE EMOTIONS %

	BEGIN NEW A,B;	ADDTO('PSTRONGFEEL,-5); ADDTO('PMAFIA,-5);
	IF AGET(REACTTO,'CLASS) THEN NIL
	ELSE IF BASSOC(A, '((INSULT.ANGER)(WEAKINSULT.PERS)(COMPLEMENT.DISTANCE)
		(SENSATTITUDE.SENSREPLIES)(CRAZY.HOSTILEREPLIES)(THREAT.PANIC)
		(DISBELIEF.BELIEVEREPLIES)(APOLOGY.ACCUSE)(LYING.BELIEVEREPLIES) ) )
		THEN BB
	ELSE IF A='DISTRUST THEN B(IF FEAR+ANGER14 THEN 'TURNOFF ELSE 'ALOOF)
	;
	IF ANGER14  FEAR14 THEN RETURN CHOOSE B;
	IF FJUMP  AJUMP  MEMQ(STOPIC, '(BYE MAFIA GAMES IYOUME FEELINGS STRONGFEELINGS))
	  THEN RETURN( IF FEAR14 THEN FEARMODE() ELSE ANGERMODE() );
	RETURN CHOOSE B;
	END;

EXPR PARANOIA();

	BEGIN NEW A;
	ASSERT('?*DTRUSTWORTHY);
	FOR NEW I IN PARBEL DO  IF MEMQ(I,'(LYING LOSER CRAZY DUMB))
	  THEN ADDTO(I,-1) ALSO AI;
	IF A THEN AASSOC(A,
	 '( (LYING . ?*DHONEST)(LOSER . ?*DSOCIABLE)(CRAZY . DABNORMAL) (DUMB . ?*DCHELP) ))
	  ALSO ASSERT(A);
	PARBELNIL;
	END;

END.
